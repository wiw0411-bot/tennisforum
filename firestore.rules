rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Nickname Uniqueness Check ---
    match /nicknames/{nickname} {
      // Anyone can check for nickname existence during signup.
      allow read: if true;
      // Only an authenticated user can create a nickname document,
      // and it must be associated with their own UID.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // --- User Profiles ---
    match /users/{userId} {
      // [보안 강화] 오직 사용자 본인과 관리자만 전체 프로필 정보를 조회할 수 있습니다.
      // 이를 통해 다른 사용자가 연락처 등 민감한 정보에 접근하는 것을 차단합니다.
      allow get: if request.auth.uid == userId || isAdmin();
      
      // 관리자만 전체 사용자 목록을 조회할 수 있습니다.
      allow list: if isAdmin();
      
      // 사용자는 자신의 프로필만 생성할 수 있으며, 스스로 관리자 역할을 부여할 수 없습니다.
      allow create: if request.auth.uid == userId && request.resource.data.role == 'user';
      
      // [보안 강화] 사용자는 자신의 프로필 중 'name'과 'avatarUrl' 필드만 수정할 수 있습니다.
      // 역할(role), 가입일(createdAt), 연락처(phone) 등 다른 민감 정보는 수정할 수 없습니다.
      // 관리자는 모든 필드를 수정할 수 있습니다.
      allow update: if (
        (request.auth.uid == userId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'avatarUrl'])
        ) || isAdmin()
      );
    }

    // --- Daily Statistics ---
    match /dailyStats/{date} {
      allow get, list: if isAdmin();
      // Allow create for first view, update for subsequent. `set` with merge covers both.
      // This is permissive, allowing any client to increment views, which matches
      // the logic for individual post view counts.
      allow write: if true;
    }

    // --- Posts and Comments ---
    match /posts/{postId} {
      // [기능 변경] 비로그인 사용자도 게시물을 읽을 수 있도록 허용합니다.
      allow get, list: if true;
      
      // [보안 강화] 게시물 생성 시 데이터 유효성을 검사합니다. (작성자 ID 일치, 제목 존재, 조회수/댓글 수 0 등)
      allow create: if isSignedIn()
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.title is string && request.resource.data.title.size() > 0
                    && request.resource.data.views == 0
                    && request.resource.data.commentCount == 0
                    && request.resource.data.createdAt == request.time;
      
      // [보안 강화] 게시물 수정 권한을 세분화하여 데이터 무결성을 강화합니다.
      allow update: if (isAdmin())
                    || (
                        // 게시물 작성자는 조회수(views)나 댓글 수(commentCount)를 제외한 필드만 수정할 수 있습니다.
                        request.auth.uid == resource.data.authorId 
                        && request.resource.data.authorId == resource.data.authorId
                        && request.resource.data.createdAt == resource.data.createdAt
                        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['views', 'commentCount'])
                       )
                    || (
                        // 모든 사용자는 조회수(views)를 1씩 증가시키는 것만 허용됩니다.
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])
                        && request.resource.data.views == resource.data.views + 1
                       )
                    || (
                        // 로그인한 사용자는 댓글 수(commentCount)를 1씩 증감시키는 것만 허용됩니다. (댓글 작성/삭제 시)
                        isSignedIn() &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount'])
                        && (
                          request.resource.data.commentCount == resource.data.commentCount + 1 ||
                          request.resource.data.commentCount == resource.data.commentCount - 1
                        )
                       );

      allow delete: if request.auth.uid == resource.data.authorId || isAdmin();

      // Comments Subcollection
      match /comments/{commentId} {
        // [보안 강화] 로그인한 사용자만 댓글을 읽거나 작성할 수 있습니다.
        allow get, list, create: if isSignedIn();
        
        // 댓글 작성자, 게시물 작성자, 또는 관리자만 댓글을 삭제할 수 있습니다.
        allow delete: if (request.auth.uid == resource.data.authorId)
                      || (request.auth.uid == get(/databases/$(database)/documents/posts/$(postId)).data.authorId)
                      || isAdmin();
      }
    }

    // --- Announcements & Advertisements (Admin Only) ---
    match /announcements/{announcementId} {
      // [기능 변경] 비로그인 사용자도 공지사항/광고를 읽을 수 있도록 허용합니다.
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    match /advertisements/{adId} {
      // [기능 변경] 비로그인 사용자도 공지사항/광고를 읽을 수 있도록 허용합니다.
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- User-Specific Subcollections ---
    // [구조 개선] 사용자는 자신의 하위 컬렉션(북마크, 수익, 메모 등)에 대해서만 접근 권한을 가집니다.
    // 반복되는 규칙을 하나로 통합하여 관리 효율성을 높입니다.
    match /users/{userId}/{collection}/{docId} {
        allow read, write: if request.auth.uid == userId;
    }
  }
}
