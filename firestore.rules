
// 중요: 드디어 원인을 찾았습니다! 아래의 '최종 FIREBASE STORAGE 규칙'을 적용해주세요.
//
// 원인:
// 기존 Storage 규칙의 'isAdmin' 함수가 관리자 계정을 제대로 인식하지 못했습니다.
// 임시로 모든 사용자에게 권한을 열어주니 업로드가 성공한 것입니다.
//
// 해결 방법:
// 아래의 '최종 FIREBASE STORAGE 규칙'은 보안을 다시 강화하면서도
// 관리자 이메일('wnxogud12@naver.com')을 직접 확인하여 안정적으로 작동합니다.
//
// 1. Firebase 콘솔의 Storage > 규칙 탭으로 이동하세요.
// 2. 편집기의 모든 내용을 지우고, 아래 '최종 FIREBASE STORAGE 규칙' 블록 전체를 복사하여 붙여넣으세요.
// 3. '게시(Publish)' 버튼을 클릭하여 저장하면 모든 문제가 해결됩니다.
//
// --- START: 최종 FIREBASE STORAGE 규칙 (이 부분을 복사하세요) ---
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // 관리자 이메일을 직접 확인하는 함수 (더 안정적임)
    function isHardcodedAdmin() {
      return request.auth.token.email == 'wnxogud12@naver.com';
    }

    // 모든 파일에 대해 공개적인 읽기 허용
    match /{allPaths=**} {
      allow read;
    }

    // 인증된 사용자는 자신의 아바타 폴더에만 쓰기 가능
    match /avatars/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 인증된 사용자는 게시물(posts) 폴더에 쓰기 가능
    match /posts/{allPaths=**} {
      allow write: if request.auth != null;
    }
    
    // 관리자만 공지사항(announcements) 폴더에 쓰기 가능
    match /announcements/{allPaths=**} {
      allow write: if request.auth != null && isHardcodedAdmin();
    }
  }
}
// --- END: 최종 FIREBASE STORAGE 규칙 ---


// --- START: FIRESTORE 규칙 (이 파일은 수정할 필요 없습니다) ---
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- User Profiles ---
    match /users/{userId} {
      // [보안 강화] 오직 사용자 본인과 관리자만 전체 프로필 정보를 조회할 수 있습니다.
      // 이를 통해 다른 사용자가 연락처 등 민감한 정보에 접근하는 것을 차단합니다.
      allow get: if request.auth.uid == userId || isAdmin();
      
      // 관리자만 전체 사용자 목록을 조회할 수 있습니다.
      allow list: if isAdmin();
      
      // 사용자는 자신의 프로필만 생성할 수 있으며, 스스로 관리자 역할을 부여할 수 없습니다.
      allow create: if request.auth.uid == userId && request.resource.data.role == 'user';
      
      // 사용자는 자신의 프로필만 수정할 수 있으며, 역할(role)이나 가입일(createdAt) 등 중요 정보는 변경할 수 없습니다.
      allow update: if (request.auth.uid == userId
                      && request.resource.data.role == resource.data.role
                      && request.resource.data.createdAt == resource.data.createdAt
                    ) || isAdmin();
    }

    // --- Posts and Comments ---
    match /posts/{postId} {
      allow get, list: if isSignedIn();
      
      // [보안 강화] 게시물 생성 시 데이터 유효성을 검사합니다. (작성자 ID 일치, 제목 존재, 조회수 0 등)
      allow create: if isSignedIn()
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.title is string && request.resource.data.title.size() > 0
                    && request.resource.data.views == 0
                    && request.resource.data.createdAt == request.time;
      
      // [기능 수정 및 보안 강화]
      // 1. 게시물 작성자 또는 관리자는 게시물을 수정/삭제할 수 있습니다. (작성자, 작성일 등은 변경 불가)
      // 2. 모든 로그인 사용자는 다른 내용은 변경하지 않고 '조회수'만 1씩 증가시킬 수 있습니다.
      allow update: if (isAdmin())
                    || (request.auth.uid == resource.data.authorId 
                        && request.resource.data.authorId == resource.data.authorId
                        && request.resource.data.createdAt == resource.data.createdAt)
                    || (isSignedIn()
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])
                        && request.resource.data.views == resource.data.views + 1);

      allow delete: if request.auth.uid == resource.data.authorId || isAdmin();

      // Comments Subcollection
      match /comments/{commentId} {
        allow get, list, create: if isSignedIn();
        
        // 댓글 작성자, 게시물 작성자, 또는 관리자만 댓글을 삭제할 수 있습니다. (기존 규칙 유지)
        allow delete: if (request.auth.uid == resource.data.authorId)
                      || (request.auth.uid == get(/databases/$(database)/documents/posts/$(postId)).data.authorId)
                      || isAdmin();
      }
    }

    // --- Announcements & Advertisements (Admin Only) ---
    match /announcements/{announcementId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /advertisements/{adId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // --- User-Specific Subcollections ---
    // [구조 개선] 사용자는 자신의 하위 컬렉션(북마크, 수익, 메모 등)에 대해서만 접근 권한을 가집니다.
    // 반복되는 규칙을 하나로 통합하여 관리 효율성을 높입니다.
    match /users/{userId}/{collection}/{docId} {
        allow read, write: if request.auth.uid == userId;
    }
  }
}
